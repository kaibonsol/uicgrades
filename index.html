<!DOCTYPE html>
<html>
    <head>
        <title>UIC Grade Distributions</title>
        <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
        <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <!--Load the AJAX API-->
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
        <script>
            var db = new Dexie("Terms")

            db.version(1).stores({
                term: 'key'
            })

            async function save(trm, data) {
                db.term.get({key:trm})
                .then(r => {
                    if (r == undefined && data)
                        db.term.add({key:trm, data})
                })

            }

            // Load the Visualization API and the corechart package.
            google.charts.load('current', {'packages':['corechart']})

            function drawBarChart(raw_data, trm) {
                var grades = [["Grade", "Frequency", {type:'string', role: 'tooltip'}]]
                var letters = ["F","D","C","B","A"]
                letters.forEach(l => {
                    grades.push(
                        [
                            l, parseInt(raw_data[l]), 
                            "Frequency: " + raw_data[l] + " (" +
                            String(
                                Math.round((parseFloat(raw_data[l]/raw_data["Grade Regs"])*100  + Number.EPSILON) * 100) / 100
                            ) + "%)"
                        ]
                    )
                })

                var data = google.visualization.arrayToDataTable(grades)
                var view = new google.visualization.DataView(data)

                view.setColumns([0,1,2])
                // view.setColumns([0, 1,
                //                 { calc: "stringify",
                //                     sourceColumn: 1,
                //                     type: "string",
                //                     role: "annotation" }])

                var options = {
                    title: raw_data["CRS SUBJ CD"] + raw_data["CRS NBR"] + " " + "Grade Distribution",
                    width: 800,
                    height: 400,
                    bar: {groupWidth: "95%"},
                    legend: { position: "none" },
                }

                // TODO: I want to add it so that it calculates the proportion of each as a label when you hover

                var chart = new google.visualization.ColumnChart(document.getElementById("bar-chart"))
                chart.draw(view, options);

                // update headings
                document.querySelector(".data-screen ul").removeAttribute("hidden")
                var title = document.getElementById("class-title")
                var prof = document.getElementById("professor")
                var term = document.getElementById("class-term")
                var withdraws = document.getElementById("withdraws")
                var regs = document.getElementById("regs")
                var sats = document.getElementById("sats")
                title.innerText = raw_data["CRS SUBJ CD"] + raw_data["CRS NBR"] + ": " + raw_data["CRS TITLE"]
                prof.innerText = "Primary Instructor: " + raw_data["Primary Instructor"]
                if (trm.slice(0, 2) == "sp") {
                    trm = "Spring 20" + trm.slice(-2)
                } else if (trm.slice(0, 2) == "fa") {
                    trm = "Fall 20" + trm.slice(-2)
                } else if (trm.slice(0, 2) == "su") {
                    trm = "Summer 20" + trm.slice(-2)
                }
                term.innerText = "Term: " + trm
                withdraws.innerText = "Withdraws: " + raw_data["W"]
                regs.innerText = "Total Registered: " + raw_data["Grade Regs"]
                sats.innerText = "Satisfactory/Unsatisfactory: " + raw_data["S"] + "/" + raw_data["U"]
            }

        </script>
        <style>
            body {
                margin:0;
            }
            .container {
                align-items: center;
                display: flex;
                justify-content: center;
                height:32vh;
            }
            .container li {
                display: inline-block;
                margin-left:2vh;
            }

            .data-screen {
                align-items: center;
                display: relative;
                justify-content: center;
                font-family:sans-serif;
                margin-top:5vh;
                width:75%;
                margin: 0 auto;
            }

            .data-screen li {
                display: block;
                margin-bottom:1vh;
            }
        </style>
    </head>
    <body>
        <header class="mdc-top-app-bar">
            <div class="mdc-top-app-bar__row">
                <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
                <span class="mdc-top-app-bar__title">UIC Grade Distribution App</span>
                </section>
                <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end" role="toolbar">
                <button class="material-icons mdc-top-app-bar__action-item mdc-icon-button" aria-label="Favorite">favorite</button>
                <button class="material-icons mdc-top-app-bar__action-item mdc-icon-button" aria-label="Search">search</button>
                </section>
            </div>
        </header>
        <main class="mdc-top-app-bar--fixed-adjust">
        
            <div class="container">
                <ul>
                    <li>
                        <label class="mdc-text-field mdc-text-field--filled">
                            <span class="mdc-text-field__ripple"></span>
                            <span class="mdc-floating-label" id="my-label-id">Term</span>
                            <input class="mdc-text-field__input" id="term" type="text" placeholder="SP09"
                                aria-labelledby="my-label-id"
                                aria-controls="my-helper-id"
                                aria-describedby="my-helper-id">
                            <span class="mdc-line-ripple"></span>
                        </label>
                    </li>
                    <li>
                        <label class="mdc-text-field mdc-text-field--filled">
                            <span class="mdc-text-field__ripple"></span>
                            <span class="mdc-floating-label" id="my-label-id">Course Abbreviation</span>
                            <input class="mdc-text-field__input" id="course-abbrev" type="text" placeholder="CS"
                                aria-labelledby="my-label-id"
                                aria-controls="my-helper-id"
                                aria-describedby="my-helper-id">
                            <span class="mdc-line-ripple"></span>
                        </label>
                    </li>
                    <li>
                        <label class="mdc-text-field mdc-text-field--filled">
                            <span class="mdc-text-field__ripple"></span>
                            <span class="mdc-floating-label" id="my-label-id">Course Number</span>
                            <input class="mdc-text-field__input" id="course-num" type="text" placeholder="301"
                                aria-labelledby="my-label-id"
                                aria-controls="my-helper-id"
                                aria-describedby="my-helper-id">
                            <span class="mdc-line-ripple"></span>
                        </label>
                    </li>
                    <li>
                        <button class="mdc-button mdc-button--raised mdc-button--leading" id="search-btn">
                            <span class="mdc-button__ripple"></span>
                            <i class="material-icons mdc-button__icon" aria-hidden="true">forward</i>
                            <span class="mdc-button__label">Search Away!</span>
                        </button>
                    </li>
                </ul>
            </div>
            <div class="data-screen">
                <ul id="info" hidden="true">
                <li><h2 id="class-title"></h2></li>
                <li><h3 id="professor"></h3></li>
                <li><h3 id="class-term"></h3></li>
                <li><div id="bar-chart"></div></li>
                <li><h4 id="withdraws"></h4></li>
                <li><h4 id="regs"></h4></li>
                <li><h4 id="sats"></h4></li>
                </ul>
            </div>
        </main>
        <aside class="mdc-snackbar">
            <div class="mdc-snackbar__surface" role="status" aria-relevant="additions">
              <div class="mdc-snackbar__label" aria-atomic="false">
                
              </div>
            </div>
          </aside>
        <script>
            /* initialize MDC components */
            console.log(mdc)
            document.querySelectorAll('.mdc-text-field').forEach(el => {
                mdc.textField.MDCTextField.attachTo(el)
            })
            mdc.ripple.MDCRipple.attachTo(document.querySelector('.mdc-button'))
            var snackbar = mdc.snackbar.MDCSnackbar.attachTo(document.querySelector('.mdc-snackbar'))

            /* query logic */
            document.getElementById("search-btn").addEventListener("click", () => {
                var trm = document.getElementById("term").value.toLowerCase()
                var abbrev = document.getElementById("course-abbrev").value.toUpperCase()
                var num = document.getElementById("course-num").value

                /* validate inputs */
                if (!trm) {
                    snackbar.labelText = "Error: You must enter a term."
                    snackbar.open()
                    return;
                }
                if (!abbrev) {
                    snackbar.labelText = "Error: You must enter a course abbreviation."
                    snackbar.open()
                    return;
                }
                var season = trm.slice(0, 2)
                var year = trm.slice(-2)
                if (trm.length != 4 || 
                    (season != "sp" && season != "fa" && season != "su") ||
                    (isNaN(year))) {
                    snackbar.labelText = "Error: Term must be SP/FA/SU + 2 digit number, like SP09 for Spring 2009."
                    snackbar.open()
                    return;
                }
                if (/\d/.test(abbrev) || abbrev.length > 5) {
                    snackbar.labelText = "Error: Must enter abbreviation, like CS for Computer Science."
                    snackbar.open()
                    return;
                }
                if (num.length != 3 || isNaN(num) || num > 700 || num <= 0) {
                    snackbar.labelText = "Error: Course Number must be a valid 3 digit number, like 342."
                    snackbar.open()
                    return;
                }
                

                document.getElementById("info").setAttribute("hidden", "true")

                function displayResults(r, trm) {
                    // now we have access to the data
                    data = r[Object.keys(r)[0]]
                    if (abbrev && !num) { // list department courses
                        
                    }
                    else if (abbrev && num) { // if more than one, offer list, if only one, show graph
                        if (data[abbrev][num] && data[abbrev][num].length == 1) {
                            console.log(data[abbrev][num])
                            drawBarChart(data[abbrev][num][0], trm)  
                        } else {
                            console.log("nope")
                        }
                    }
                }

                // search given these values
                // I want to make it so you don't necessarily have to fill out every form
                // make API calls to kbonsol.tech/grades?term
                // I want to store terms into indexedDB for faster lookup and to
                // reduce stress on my free heroku app lolol

                if (trm) {
                    db.term.get(trm)
                    .then(r => {
                        if (r == undefined) { // we want to cache this into indexedDB for future use
                            fetch("https://kbonsol.herokuapp.com/grades?" + trm)
                                .then(resp => {
                                    return resp.json()
                                })
                                .then(json => {
                                    save(trm, json)
                                    console.log("succ. saved")
                                    displayResults(json, trm)
                                })
                        } else { // it exists in indexedDB and we want to pull it up
                            displayResults(r.data, trm)
                        }
                    })
                }


            })
        </script>
    </body>
</html>