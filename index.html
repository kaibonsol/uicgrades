<!DOCTYPE html>
<html>
    <head>
        <title>UIC Grade Distributions</title>
        <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
        <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <!--Load the AJAX API-->
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
        <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
        <script>
            var db = new Dexie("Terms")

            db.version(1).stores({
                term: 'key'
            })

            async function save(trm, data) {
                db.term.get({key:trm})
                .then(r => {
                    if (r == undefined && data)
                        db.term.add({key:trm, data})
                })

            }

            // Load the Visualization API and the corechart package.
            google.charts.load('current', {'packages':['corechart']})

            function drawBarChart(raw_data, trm) {
                var grades = [["Grade", "Frequency"]]
                var letters = ["F","D","C","B","A"]
                letters.forEach(l => {grades.push([l, parseInt(raw_data[l])])})

                var data = google.visualization.arrayToDataTable(grades)
                var view = new google.visualization.DataView(data)

                view.setColumns([0, 1,
                                { calc: "stringify",
                                    sourceColumn: 1,
                                    type: "string",
                                    role: "annotation" }])

                var options = {
                    title: raw_data["CRS SUBJ CD"] + raw_data["CRS NBR"] + " " + "Grade Distribution",
                    width: 800,
                    height: 400,
                    bar: {groupWidth: "95%"},
                    legend: { position: "none" },
                }

                var chart = new google.visualization.ColumnChart(document.getElementById("bar-chart"))
                chart.draw(view, options);

                // update headings
                document.querySelector(".data-screen ul").removeAttribute("hidden")
                var title = document.getElementById("class-title")
                var prof = document.getElementById("professor")
                var term = document.getElementById("class-term")
                title.innerText = raw_data["CRS SUBJ CD"] + raw_data["CRS NBR"] + ": " + raw_data["CRS TITLE"]
                prof.innerText = "Primary Instructor: " + raw_data["Primary Instructor"]
                console.log(trm)
                console.log(trm.slice(0, 2))
                console.log(trm.slice(-2))
                if (trm.slice(0, 2) == "sp") {
                    trm = "Spring 20" + trm.slice(-2)
                } else if (trm.slice(0, 2) == "fa") {
                    trm = "Fall 20" + trm.slice(-2)
                } else if (trm.slice(0, 2) == "su") {
                    trm = "Summer 20" + trm.slice(-2)
                }
                term.innerText = "Term: " + trm
            }

        </script>
        <style>
            body {
                margin:0;
            }
            .container {
                align-items: center;
                display: flex;
                justify-content: center;
                height:32vh;
            }
            .container li {
                display: inline-block;
                margin-left:2vh;
            }

            .data-screen {
                align-items: center;
                display: relative;
                justify-content: center;
                height:40vh;
                font-family:sans-serif;
                margin-top:5vh;
                width:75%;
                margin: 0 auto;
            }

            .data-screen li {
                display: block;
                margin-bottom:1vh;
            }
        </style>
    </head>
    <body>
        <header class="mdc-top-app-bar">
            <div class="mdc-top-app-bar__row">
                <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
                <span class="mdc-top-app-bar__title">UIC Grade Distribution App</span>
                </section>
                <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end" role="toolbar">
                <button class="material-icons mdc-top-app-bar__action-item mdc-icon-button" aria-label="Favorite">favorite</button>
                <button class="material-icons mdc-top-app-bar__action-item mdc-icon-button" aria-label="Search">search</button>
                </section>
            </div>
        </header>
        <main class="mdc-top-app-bar--fixed-adjust">
        
            <div class="container">
                <ul>
                    <li>
                        <label class="mdc-text-field mdc-text-field--filled">
                            <span class="mdc-text-field__ripple"></span>
                            <span class="mdc-floating-label" id="my-label-id">Term</span>
                            <input class="mdc-text-field__input" id="term" type="text" placeholder="SP09"
                                aria-labelledby="my-label-id"
                                aria-controls="my-helper-id"
                                aria-describedby="my-helper-id">
                            <span class="mdc-line-ripple"></span>
                        </label>
                    </li>
                    <li>
                        <label class="mdc-text-field mdc-text-field--filled">
                            <span class="mdc-text-field__ripple"></span>
                            <span class="mdc-floating-label" id="my-label-id">Course Abbreviation</span>
                            <input class="mdc-text-field__input" id="course-abbrev" type="text" placeholder="CS"
                                aria-labelledby="my-label-id"
                                aria-controls="my-helper-id"
                                aria-describedby="my-helper-id">
                            <span class="mdc-line-ripple"></span>
                        </label>
                    </li>
                    <li>
                        <label class="mdc-text-field mdc-text-field--filled">
                            <span class="mdc-text-field__ripple"></span>
                            <span class="mdc-floating-label" id="my-label-id">Course Number</span>
                            <input class="mdc-text-field__input" id="course-num" type="text" placeholder="420"
                                aria-labelledby="my-label-id"
                                aria-controls="my-helper-id"
                                aria-describedby="my-helper-id">
                            <span class="mdc-line-ripple"></span>
                        </label>
                    </li>
                    <li>
                        <button class="mdc-button mdc-button--raised mdc-button--leading" id="search-btn">
                            <span class="mdc-button__ripple"></span>
                            <i class="material-icons mdc-button__icon" aria-hidden="true">forward</i>
                            <span class="mdc-button__label">Search Away!</span>
                        </button>
                    </li>
                </ul>
            </div>
            <div class="data-screen">
                <ul id="info" hidden="true">
                <li><h2 id="class-title"></h2></li>
                <li><h3 id="professor"></h3></li>
                <li><h3 id="class-term"></h3></li>
                <li><div id="bar-chart"></div></li>
                </ul>
            </div>
        </main>
        <script>
            console.log(mdc)
            document.querySelectorAll('.mdc-text-field').forEach(el => {
                mdc.textField.MDCTextField.attachTo(el)
            })
            mdc.ripple.MDCRipple.attachTo(document.querySelector('.mdc-button'))

            document.getElementById("search-btn").addEventListener("click", () => {
                var trm = document.getElementById("term").value.toLowerCase()
                var abbrev = document.getElementById("course-abbrev").value.toUpperCase()
                var num = parseInt(document.getElementById("course-num").value)

                /* validate inputs */
                if (trm && !abbrev && !num) {

                }

                document.getElementById("info").setAttribute("hidden", "true")

                function displayResults(r, trm) {
                    // now we have access to the data
                    data = r[Object.keys(r)[0]]
                    if (!abbrev && !num) { // might not support this one use snackbar

                    }
                    else if (abbrev && !num) { // list department courses
                        
                    }
                    else if (abbrev && num) { // if more than one, offer list, if only one, show graph
                        if (data[abbrev][num] && data[abbrev][num].length == 1) {
                            console.log(data[abbrev][num])
                            drawBarChart(data[abbrev][num][0], trm)  
                        } else {
                            console.log("nope")
                        }
                    }
                }

                // search given these values
                // I want to make it so you don't necessarily have to fill out every form
                // make API calls to kbonsol.tech/grades?term
                // I want to store terms into indexedDB for faster lookup and to
                // reduce stress on my free heroku app lolol

                if (trm) {
                    db.term.get(trm)
                    .then(r => {
                        if (r == undefined) { // we want to cache this into indexedDB for future use
                            fetch("http://kbonsol.tech/grades?" + trm)
                                .then(resp => {
                                    return resp.json()
                                })
                                .then(json => {
                                    save(trm, json)
                                    console.log("succ. saved")
                                    displayResults(json, trm)
                                })
                        } else { // it exists in indexedDB and we want to pull it up
                            displayResults(r.data, trm)
                        }
                    })
                }


            })
        </script>
    </body>
</html>